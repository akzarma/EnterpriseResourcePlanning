{% extends "./base.html" %}
{% load humanize %}
{% block style %}
    <style>
        /*
        DEMO STYLE
    */
        label {
            margin-left: 20px;
        }

        .cb {
            margin-right: 10%;
        }

        .custom-menu {
            display: none;
            z-index: 1000;
            position: absolute;
            overflow: hidden;
            border: 1px solid #CCC;
            white-space: nowrap;
            font-family: sans-serif;
            background: #FFF;
            color: #333;
            border-radius: 5px;
            padding: 0;
        }

        /* Each of the items in the list */
        .custom-menu li {
            padding: 8px 12px;
            cursor: pointer;
            list-style-type: none;
            transition: all .3s ease;
            user-select: none;
        }

        .custom-menu li:hover {
            background-color: #DEF;
        }

        #datepicker {
            width: 180px;
            margin: 0 20px 20px 20px;
        }

        #datepicker > span:hover {
            cursor: pointer;
        }

        body {

            background: #fafafa;
        }

        p {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1em;
            font-weight: 300;
            line-height: 1.7em;
            color: #999;
        }

        a, a:hover, a:focus {
            color: inherit;
            text-decoration: none;
            transition: all 0.3s;
        }

        .navbar-btn {
            box-shadow: none;
            outline: none !important;
            border: none;
        }

        .line {
            width: 100%;
            height: 1px;
            border-bottom: 1px dashed #ddd;
            margin: 40px 0;
        }

        /* ---------------------------------------------------
            SIDEBAR STYLE
        ----------------------------------------------------- */
        .wrapper {
            display: flex;
            align-items: stretch;
            overflow-x: hidden;
        }

        #sidebar {
            min-width: 250px;
            max-width: 250px;
            background: #fff;
            color: rgb(0, 181, 197);
            transition: all 0.3s;
        }

        #sidebar.active {
            margin-left: -250px;
        }

        #sidebar .sidebar-header {
            padding: 20px;
            background: rgb(0, 181, 197);
        }

        #sidebar ul.components {
            padding: 20px 0;
        }

        #sidebar ul p {
            color: #fff;
            padding: 10px;
        }

        #sidebar ul li a {
            color: #444444;
            padding: 10px;
            font-size: 1.1em;
            display: block;
        }

        #sidebar ul li a:hover {
            background: rgb(231, 231, 231);
        }

        #sidebar ul li ul li a:hover {
            color: #fff;
            background: rgb(0, 138, 150);
        }

        #sidebar ul li.active > a, a[aria-expanded="true"] {
            color: #fff;
            background: rgb(0, 181, 197);

        }

        #sidebar a[data-toggle="collapse"] {
            position: relative;
        }

        #sidebar a[aria-expanded="false"]::before, #sidebar a[aria-expanded="true"]::before {
            content: '\e259';
            display: block;
            position: absolute;
            right: 20px;
            font-family: 'Glyphicons Halflings', sans-serif;
            font-size: 0.6em;
        }

        #sidebar a[aria-expanded="true"]::before {
            content: '\e260';
        }

        #sidebar ul ul a {
            font-size: 0.9em !important;
            padding-left: 30px !important;
            background: rgb(0, 158, 183);
            color: #fff;
        }

        #sidebar ul.CTAs {
            padding: 20px;
        }

        #sidebar ul.CTAs a {
            text-align: center;
            font-size: 0.9em !important;
            display: block;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        /* ---------------------------------------------------
            CONTENT STYLE
        ----------------------------------------------------- */
        #content {
            padding: 20px;
            min-height: 100vh;
            transition: all 0.3s;
            width: 100%;
        }

        /* ---------------------------------------------------
            MEDIAQUERIES
        ----------------------------------------------------- */
        @media (max-width: 768px) {
            #sidebar {
                margin-left: -250px;
            }

            #sidebar.active {
                margin-left: 0;
            }

            #sidebarCollapse span {
                display: none;
            }
        }

        #sidebarCollapse {
            visibility: hidden;
        }

        .navbar-default {
            margin-bottom: 0;
        }

        /* Media query to show side bar toggle button  on  small screen */
        @media only screen and (max-width: 480px) {
            #sidebarCollapse {
                visibility: visible;
            }
        }

        #head {
            margin-left: 5px;
            font-weight: bold;
            color: #0379C4 !important;
        }

        .carousel-control.left, .carousel-control.right {
            background-image: none !important;
            filter: none !important;
        }

        {% block extra_style %}
            /* .squaredOne */

            .squaredOne {
                width: 50px;
                height: 50px;
                position: relative;
                z-index: 0;
                background: rgb(186, 188, 182);
                color: white;
            }

            .squaredOne label {
                width: 45px;
                height: 45px;
                position: absolute;
                top: 2px;
                left: 2px;
                cursor: pointer;
                padding-top: 20%;
                text-align: center;
                margin-left: 0px !important;
            }

            .squaredOne label:after {
                content: ' ';
                width: 50px;
                height: 50px;
                position: absolute;
                top: -1px;
                left: -1px;
                background: #5bc0de;
                z-index: -1;
                opacity: 0;
            }

            .squaredOne label:hover::after {
                opacity: 0.3;
            }

            .squaredOne input[type=checkbox] {
                visibility: hidden;
            }

            .squaredOne input[type=checkbox]:checked + label:after {
                opacity: 1;
            }

            /* end .squaredOne */

            /*Overlay*/
            .overlay {
                display: none; /* Hidden by default */
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5); /* Black background with opacity */
            }
        {% endblock extra_style %}

    </style>

{% endblock style %}

{% block body %}




    <div class="wrapper">
        <!-- Sidebar Holder -->
        <nav id="sidebar">
            <ul class="list-unstyled components">
                <p id="head">Dashboard</p>
                <li class="active">
                    <a href="/dashboard/">Dashboard</a>
                </li>
                <li>
                    <a href="{% url 'attendance:select_cat' %}">Fill or Check Attendance</a>
                </li>

                <li>
                    <a href="#excelSubmenu" data-toggle="collapse" aria-expanded="false">Excel</a>
                    <ul class="collapse list-unstyled" id="excelSubmenu">
                        <li><a href="{% url 'dashboard:excel_timetable' %}">TimeTable</a></li>
                        <li><a href="{% url 'dashboard:excel_room_schedule' %}">Room Schedule</a></li>
                        <li><a href="{% url 'dashboard:excel_attendance' %}">Attendance</a></li>

                        {#                        <li><a href="{% url 'attendance:excel_student' %}">Student</a></li>#}
                        {#                        <li><a href="{% url 'dashboard:excel_faculty' %}">Fcaulty</a></li>#}
                    </ul>
                </li>
                {##}
                {#                <li>#}
                {#                    <a href="{% url 'update:update' %}">Update</a>#}
                {#                </li>#}
                {#                <li>#}
                {#                    <a href="{% url 'attendance:select_cat' %}">Check Attendance</a>#}
                {#                </li>#}

                <li>
                    <a href="#registermenu" data-toggle="collapse" aria-expanded="false">Register</a>
                    <ul class="collapse list-unstyled" id="registermenu">
                        <li><a href="{% url 'registration:register_subject' %}">Subject</a></li>
                        <li><a href="{% url 'registration:register_faculty_subject' %}">Bind faculty with subject</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Page Content Holder -->
        <div id="content">
            {% block content %}
                <div class="row">
                    <div class="col-md-4">
                        <legend>Timetable</legend>

                        {#                            <input type="hidden" name="selected_date"#}
                        {#                                   value="{{ selected_date }}">#}
                        <form action="{% url 'dashboard:dashboard' %}" method="post" onsubmit="event.preventDefault();"
                              id="date_form">
                            {% csrf_token %}
                            <h4 style="text-align:center;text-transform: uppercase ">Lectures
                                on {{ selected_date }}
                                {#                                <div id="datepicker" class="input-group date" data-date-format="mm-dd-yyyy">#}
                                {#                                    <input class="form-control" type="text" value="{{ selected_date.month }}-{{ selected_date.day }}-{{ selected_date.year }}"/>#}
                                {#                                    <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>#}
                                {#                                </div>#}

                                <button id="dateButton" name="GO" type="submit" class="btn btn-default">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </button>
                                <input type="text" name="selected_date" id="txtDate"
                                       style="display: none;" onchange="change_timetable()">

                                {#                                <button type="button" name="GO" class="btn btn-default" id="datepickerbtn">#}
                                {#                                    <span class="glyphicon glyphicon-calendar"></span>#}
                                {#                                </button>#}

                            </h4>
                        </form>


                        <br/>
                        <form method="post" action="{% url 'dashboard:dashboard' %}" id="timetable_form">
                            {% csrf_token %}
                            <input type="hidden" name="selected_date" id="hidden_date" value="{{ selected_date }}">
                            <div class="row" id="timetable">
                                {% if timetable %}
                                    {% for each in timetable %}
                                        <button name="date_timetable" class="card btn btn-info my-context-menu"
                                                style="width: 100%; font-weight: bold; margin-bottom: 5px;"
                                                value="{{ each.pk }}"
                                                onclick="checkTimetable(this);">
                                            {% if each.not_available == True %}
                                                <div id="{{ each.pk }}" style="display: block !important;"
                                                     name="{{ each.pk }}" class="overlay my-context-menu">I'm not
                                                    available
                                                </div>
                                            {% else %}
                                                <div id="{{ each.pk }}" name="{{ each.pk }}"
                                                     class="overlay my-context-menu">I'm not available
                                                </div>
                                            {% endif %}
                                            {% if each.is_substituted is True %}
                                                <div class="card-header my-context-menu"
                                                     style="border-bottom: 2px solid white;"
                                                     name="{{ each.pk }}">{{ each.substitute.time }}</div>
                                                <div class="row my-context-menu">
                                                    <div class="col-md-4 my-context-menu"
                                                         name="{{ each.pk }}">{{ each.substitute.branch_subject.subject.short_form }}</div>
                                                    <div class="col-md-4 my-context-menu"
                                                         name="{{ each.pk }}">{{ each.substitute.room.room_number }}</div>
                                                    <div class="col-md-4 my-context-menu" name="{{ each.pk }}">
                                                        {{ each.substitute.division.year_branch.branch }}<br/>
                                                        {{ each.substitute.division.year_branch.year }}
                                                        {{ each.substitute.division.division }}
                                                        {% if each.substitute.is_practical %}
                                                            {{ each.substitute.batch.batch_name }}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="card-header my-context-menu"
                                                     style="border-bottom: 2px solid white;"
                                                     name="{{ each.pk }}">{{ each.original.time }}</div>
                                                <div class="row my-context-menu" name="{{ each.pk }}">
                                                    <div class="col-md-4 my-context-menu"
                                                         name="{{ each.pk }}">{{ each.original.branch_subject.subject.short_form }}</div>
                                                    <div class="col-md-4 my-context-menu"
                                                         name="{{ each.pk }}">{{ each.original.room.room_number }}</div>
                                                    <div class="col-md-4 my-context-menu" name="{{ each.pk }}">
                                                        {{ each.original.division.year_branch.branch }}<br/>
                                                        {{ each.original.division.year_branch.year }}
                                                        {{ each.original.division.division }}
                                                        {% if each.original.is_practical %}
                                                            {{ each.original.batch.batch_name }}
                                                        {% endif %}
                                                    </div>
                                                </div>

                                            {% endif %}
                                        </button>
                                    {% endfor %}
                                    <button name="previous" value="previous" class="btn left carousel-control"
                                            style="border: 0 !important;"><span
                                            class="glyphicon glyphicon-chevron-left"></span></button>
                                    <button name="next" value="next" type="submit" class="btn right carousel-control"
                                            style="border: 0 !important;"><span
                                            class="glyphicon glyphicon-chevron-right"></span></button>
                                {% else %}
                                    <p style="text-align: center;">Sorry! No lectures on {{ selected_date }}</p>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    {% if all_students_roll %}
                        <div class="col-md-7 col-md-offset-1">
                            <legend>Mark Attendance for {{ selected_date }}</legend>
                            {% if selected_timetable.is_substituted is True %}
                                <p>{{ selected_timetable.substitute.time }}</p>
                                <p>{{ selected_timetable.substitute.branch_subject.subject.short_form }}</p>
                                <p>{{ selected_timetable.substitute.room.room_number }}</p>
                                <p>{{ selected_timetable.substitute.division.year_branch.branch }} {{ selected_timetable.substitute.division.year_branch.year }} {{ selected_timetable.substitute.division.division }}</p>
                            {% else %}
                                <p>{{ selected_timetable.original.time }}</p>
                                <p>{{ selected_timetable.original.branch_subject.subject.short_form }}</p>
                                <p>{{ selected_timetable.original.room.room_number }}</p>
                                <p>{{ selected_timetable.original.division.year_branch.branch }} {{ selected_timetable.original.division.year_branch.year }} {{ selected_timetable.original.division.division }}</p>
                            {% endif %}
                            <form action="{% url 'attendance:save' %}" method="post">
                                {% csrf_token %}
                                <input class="hidden" name="selected_timetable" value="{{ selected_timetable.pk }}">
                                <div class="container">
                                    <div class="row">
                                        {% for i in all_students_roll %}
                                            {% if forloop.counter0|divisibleby:9 %}
                                                </div>
                                                <div class="row">
                                            {% endif %}
                                            <div class="col-lg-1" id="test"
                                                 style="padding-right: 0;padding-left: 0;width: 5%">
                                                <section style="width: 50px">
                                                    <!-- .squaredOne -->
                                                    <div class="squaredOne">
                                                        {% if not att %}
                                                            <input class="cb" type="checkbox" value="{{ i }}"
                                                                   id="squaredOne{{ forloop.counter }}"
                                                                   name="present"/>
                                                        {% else %}
                                                            {% if i in present_roll %}
                                                                <input class="cb" type="checkbox" value="{{ i }}"
                                                                       id="squaredOne{{ forloop.counter }}"
                                                                       name="present" checked/>
                                                            {% else %}
                                                                <input class="cb" type="checkbox" value="{{ i }}"
                                                                       id="squaredOne{{ forloop.counter }}"
                                                                       name="present"/>
                                                            {% endif %}
                                                        {% endif %}
                                                        <label for="squaredOne{{ forloop.counter }}">{{ i }}</label>
                                                    </div>
                                                    <!-- end .squaredOne -->
                                                </section>
                                            </div>
                                            {#                                        {% if forloop.counter0|divisibleby:12 %}#}
                                            {#                                            </div>#}
                                            {#                                        {% endif %}#}
                                        {% endfor %}
                                        </div>
                                    <div class="row">
                                        <input class="btn btn-primary" type="submit" name="save_attendance"
                                               value="Save">
                                    </div>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endblock %}
        </div>
    </div>

    {#For context menu#}
    <ul class='custom-menu'>
        <li data-action="availability" id="availability"></li>
    </ul>

{% endblock body %}

{% block on_ready %}
{#    <script>#}
        {#$(document).ready(function () {#}
        $('#sidebarCollapse').on('click', function () {
            $('#sidebar').toggleClass('active');
        });

        $('#txtDate').datepicker({
            dateFormat: 'dd-mm-yy',
            maxDate: 0
        });

        $('#dateButton').click(function () {
            $('#txtDate').show().focus().hide();
        });
    {#</script>#}
{% endblock on_ready %}

{% block html %}

    <script type="text/javascript">


        $(function () {
            $("#datepicker").datepicker({
                autoclose: true,
                todayHighlight: true
            }).datepicker('update', new Date());
        });

    </script>
    <script>

        var selected_ajax = "";

        function change_timetable() {
            var form = document.getElementById('date_form');
            var input = document.createElement('input');
            input.setAttribute('name', 'GO');
            input.setAttribute('type', 'hidden');
            form.appendChild(input);
            form.submit();
        }

        {#(function () {#}
        {##}
        {#    document.addEventListener("contextmenu", function (e) {#}
        {#        console.log('preventing default');#}
        {#        e.preventDefault();#}
        {#        console.log(e.path.findIndex(function (param) {#}
        {#            return param.className === 'card btn btn-info'#}
        {#        }));#}
        {#        let index = e.path.findIndex(function (param) {#}
        {#            return param.className === 'card btn btn-info'#}
        {#        });#}
        {#        console.log('inside function');#}
        {#        var text = '';#}
        {#        if (index) {#}
        {#            console.log('inside index');#}
        {#            let element = $("button[name='date_timetable'][value='" + e.path[index].value + "']");#}
        {##}
        {#            $(element).contextMenu({#}
        {#                selector: 'div',#}
        {##}
        {#                build: function ($triggerElement, e) {#}
        {#                    if (element.find('#overlay').css("display") === "none") {#}
        {#                        text = 'I am available';#}
        {#                    }#}
        {#                    else {#}
        {#                        text = 'Not';#}
        {#                    }#}
        {#                    return {#}
        {#                        callback: function (key, options) {#}
        {##}
        {#                                var m = "clicked: " + key + " on " + $(this).text;#}
        {#                            window.console && console.log(m) || alert(e.path[index]);#}
        {#                            console.log(e.path[index]);#}
        {##}
        {#                            $.ajax({#}
        {#                                url: '{% url 'dashboard:toggle_availability' %}',#}
        {#                                type: 'POST',#}
        {#                                data: {#}
        {#                                    'csrfmiddlewaretoken': '{{ csrf_token }}',#}
        {#                                    'selected_timetable': e.path[index].value,#}
        {#                                    'available': true#}
        {#                                },#}
        {#                                success: function (data) {#}
        {#                                    alert(data);#}
        {##}
        {#                                    $(element).find('#overlay').css("display", "block");#}
        {##}
        {#                                }#}
        {##}
        {#                            });#}
        {##}
        {#                        },#}
        {#                        items: {#}
        {#                            menuItem: {name: text, icon: "info"}#}
        {#                        }#}
        {#                    };#}
        {#                }#}
        {#            });#}
        {##}
        {#        }#}
        {#    })#}



        // Trigger action when the contexmenu is about to be shown
        $(document).bind("contextmenu", function (event) {
            {#console.log(event);#}
            {#console.log(event.target.classList);#}
            {#let index = -1;#}
            let arr = event.target.classList;
            let found = false;
            for (let i = 0; i < arr.length; i++) {
                {#console.log(arr[i]);#}
                if (arr[i] === "my-context-menu") {
                    found = true;
                    break;
                }
            }

            if (found === true) {


                // Avoid the real one
                event.preventDefault();

                let target = event.target;
                {#alert(target.tagName);#}
                if (target.tagName === "BUTTON") {
                    selected_ajax = target.value;

                }
                else {
                    selected_ajax = target.attributes.name.nodeValue;
                    {#alert(target.attributes.name.nodeValue);#}
                }

                {#alert($('#' + selected_ajax).css("display"));#}
                {#alert(selected_ajax);#}

                if ($('#' + selected_ajax).css("display") === 'none') {
                    document.getElementById("availability").innerHTML = "I'm not available";
                } else {
                    document.getElementById("availability").innerHTML = "I'm available";
                }

                // Show contextmenu
                $(".custom-menu").finish().toggle(100).// In the right position (the mouse)
                css({
                    top: event.pageY + "px",
                    left: event.pageX + "px"
                });
            }
        });


        // If the document is clicked somewhere
        $(document).bind("mousedown", function (e) {

            // If the clicked element is not the menu
            if (!$(e.target).parents(".custom-menu").length > 0) {

                // Hide it
                $(".custom-menu").hide(100);
            }
        });


        // If the menu element is clicked
        $(".custom-menu li").click(function () {

            // This is the triggered action name
            switch ($(this).attr("data-action")) {

                // A case for each action. Your actions here
                case "availability":
                    not_available();
                    break;
                {#case "second":#}
                {#    alert("second");#}
                {#    break;#}
                {#case "third":#}
                {#    alert("third");#}
                {#    break;#}
            }

            // Hide it AFTER the action was triggered
            $(".custom-menu").hide(100);
        });


        function not_available() {
            {#alert(selected_ajax);#}
            $.ajax({

                url: '{% url 'dashboard:toggle_availability' %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'selected_timetable': selected_ajax
                },
                success: function (data) {
                    alert(data);

                    var overlay = $('#' + selected_ajax);

                    if (overlay.css("display") === "none") {
                        overlay.css("display", "block");
                    } else {
                        overlay.css("display", "none");
                    }

                }

            });
        }

        function checkTimetable(obj) {
            var pk = obj.value;

            var overlay = $('#' + pk);
            if (overlay.css("display") === "none") {
               $("#timetable_form").submit;
            } else {
                alert('You can\'t mark attendance for this lecture');
                event.preventDefault();
            }


        }
    </script>
{% endblock html %}