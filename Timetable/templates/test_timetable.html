{% extends './base.html' %}

{% block style %}
    <style>
        html, body {
            overflow-x: hidden;
            background: #fff;
            font-family: 'Roboto', sans-serif;
        }

        legend {
            color: #0379C4;
        }

        .navbar {
            box-shadow: 0 0 40px 0 rgba(0, 0, 0, 0.1);
            background: white;
            font-family: 'Roboto', sans-serif;
            border: 0;
            padding: 10px;
        }

        .navbar-brand {
            color: #0379C4 !important;
            font-weight: bolder;
        }

        .navbar-default .navbar-nav > .active > a, .navbar-default .navbar-nav > .active > a:hover {
            background: white;
        }

        .navbar-default .navbar-nav > li {
            font-weight: bold;
        }

        .navbar-default .navbar-nav > li:hover {
            box-shadow: 0 0 40px 0 rgba(0, 0, 0, 0.1);

        }

        .navbar-toggle {
            border: none;
        }

        .navbar-toggle:active, .navbar-toggle:hover, .navbar-toggle:focus {

            background: white !important;

        }

        .form-element {
            margin: 15px 0;
        }

        .col-lg-6 {
            height: 100%;
        }

        .row {
            padding: 10px;
        }

        #myImg {
            width: 140px;
        }

        #input-file {
            padding-bottom: 15px;
        }

        #id_doc_profile_pic {
            display: none;
        }

        #id_projects {
            width: 170px;
            height: 190px;
        }

        .error {
            color: #d9534f !important;
        }

        .my-border-1 {
        {#            border: 1px black solid;#} padding: 0;
        }

        .top-border {
            border-top: 1px black solid;
        }

        .content {
            border-top: 1px black solid;
        }

        .vertical-div {
            height: 40px;
            width: 1px;
            background: red;
            display: inline-block;
        }

        .vertical-divider {
            clear: both;
            position: relative;
        }

        .vertical-divider:after {
            clear: both;
            content: " ";
            display: block;
            height: 0;
            visibility: hidden;
        }

        table, th, td {
        {#            border: 1px solid black;#} border-collapse: collapse;
            padding: 5px;
            text-align: center;
        }

        .block div {
            color: black;
            width: 33%;
            height: 100%;
            float: left;
            padding: 0;
        }

        #div1 {
            background: #DDD;
        }

        #div2 {
            background: #AAA;
        }

        #div3 {
            width: 100%;
            background: #777;
        }

        #div4 {
            background: #444;
        }

        .sidebar {
            color: #5e5e5e;
            border-bottom: 1px grey solid;
        }

        .titlebar {
            background: #fff;
            color: black;
            border-top: 2px solid gray;
            border-bottom: 2px solid gray;
            /*#D9D9D9
            #F2F2F2 */
        }

        .content:nth-child(2n) {
            background: #D9D9D9 !important;
        }

        .content:nth-child(2n+1) {
            background: #F2F2F2 !important;
        }

        .border-left {
            border-left: 3px solid white;
        }

        table {
            border: 1px gray solid;
        }

        .border-down {
            border-bottom: 2px gray solid;
        }

        .cbx {
            width: 15px; /*Desired width*/
            height: 15px; /*Desired height*/
            cursor: pointer;
            text-align: center !important;
        }

        .cbx_label {
            position: relative;
            top: -1px;

        }

        .faculty {
            position: relative;
            top: 4px;
            font-weight: bold;
        }

        .room {
            position: relative;
            left: 25%;
            right: 25%;
            top: 4px;
        {#            left: 2.5%;#}{#            right: 25%;#}
        }

        .teacher {
            position: relative;
            bottom: 2px;
            padding: 3px;
            background: #e6e6e6;
            color: #000;
        }

        .room-nos {
            position: relative;
            bottom: 2px;
            padding: 3px;
            background: #e6e6e6;
            color: #000;
        }

        input[type="checkbox"] {
            width: 30px;
            height: 30px;
        }

        .checked-cbx {
            width: 15px !important;
            height: 15px !important;

        {#position: relative;#}{#left:-40%;#}
        }

        .checked-cbx-parent {
            padding-left: 0 !important;
            padding-right: 0 !important;
            text-align: left;
        }

        .practical-cbx {

            width: 15px !important;
            height: 15px !important;
            text-align: left;
            margin-right: 100% !important;
        }

        .practical-cbx-parent {
            padding: 0 !important;
            text-align: left;
        }

        .red {
            background: red !important;
        }

        /*

            #timetable_FE {
                background: #5bc0de;
            }

            #timetable_SE {
                background: #0379C4;
            }

            #timetable_TE {
                background: darkgrey;
            }

            #timetable_BE {
                background: cyan;
            }
        */

    </style>
{% endblock style %}

{% block body %}
    <form method="post" action="{% url 'Timetable:save_timetable' %}">
        {% csrf_token %}
        <label for="id_year">Year: </label>
        <select id="id_year" onchange="set_subject()">
            {% for yr in year %}
                <option>{{ yr }}</option>
            {% endfor %}
        </select>
        <label for="id_subject">Subjects: </label>


        <select id="id_subject" onchange="change_selected_subject(this)">
        </select>

        <br>
        {% for yr in year %}
            {#                <option>{{ yr }}</option>#}
            <div class="container hidden" id="timetable_{{ yr }}">
                <table style="width:100%;" id="time_tab_{{ yr }}">
                    <tr>
                        <th colspan="2" class="titlebar">Time</th>
                        {% for day in days %}
                            <th class="titlebar">
                                {{ day }}
                            </th>
                        {% endfor %}
                    </tr>
                    {% for time in times %}
                        <tr class="border-down">
                            <th rowspan="4" class="sidebar time">
                                {{ time }}
                            </th>

                            {% for x in division %}
                                <tr class="content border-down" style="">
                                    {% for z in '1234567' %}

                                        {% if forloop.counter0 %}
                                            <td class="block border-left" style="padding: 20px;">
                                                <input type="checkbox" class="cbx"
                                                       name="id_room_{{ time }}_{{ x }}_{{ z }}_{{ yr }}"
                                                       id="id_room_{{ time }}_{{ x }}_{{ z }}_{{ yr }}_cbx"
                                                       onchange="add_remove_from_dictionary(this)">

                                            </td>
                                        {% else %}
                                            <td class="sidebar">{{ x }}</td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}

                    {% endfor %}
                </table>
                <br/>

            </div>
        {% endfor %}
        <div class="col-md-offset-6">
            <button type="submit" class="btn btn-primary">Submit</button>
        </div>
    </form>


    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Practical</h4>
                </div>
                <div class="modal-body">
                    <table style="width:100%;border: none;" id="modalBody">
                        <tr>
                            <th>Batch</th>
                            <th>Subject</th>
                            <th>Faculty</th>
                            <th>Room</th>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-default" data-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>

    </div>

{% endblock body %}

{% block html %}



    {#    Make Selected year timetable visible#}
    <script>
        var all_years = {{ year|safe }};

        function make_timetable_visible() {
            for (i = 0; i < all_years.length; i++) {
                document.getElementById('timetable_' + all_years[i]).classList.add("hidden");
            }
            let year = document.getElementById("id_year").value;
            let timetable_object = document.getElementById('timetable_' + year);
            timetable_object.classList.remove("hidden");
        }

    </script>

    <script>
        //Gets subject of theory and practical for current year.
        var subjects_json = {{ subject_json|safe }};

        var configuration = {
            "time_index": 2,
            "division_index": 3,
            "day_index": 4,
            "year_index": 5
        };

        var global_current_subject = "";

        //Sets option of combo box with subjects_json
        function set_subject() {

            var selected_year = document.getElementById("id_year").value;
            var current_subjects_theory = subjects_json[selected_year]["theory"];
            var current_subjects_practical = subjects_json[selected_year]["practical"];

            //clears select options
            $('#id_subject').find('option').remove();
            //add theory subject
            $.each(current_subjects_theory, function (i, el) {
                $('#id_subject').append(new Option(el, el))
            });
            //add practical subject
            $.each(current_subjects_practical, function (i, el) {
                $('#id_subject').append(new Option(el, el))
            });

            make_timetable_visible();

            block_all_current_subject(document.getElementById('id_subject').value, true);
        }

        global_current_subject = document.getElementById('id_subject').value;

        //Mark current year checked boxes on year change
        /*function mark_current_year(selected_year) {

            let subjects = subjects_json[selected_year];
            for (i = 0; i < subjects.length(); i++) {
                let to_check = subject_teacher_json[subjects[i]];
                for (j = 0; j < to_check.length(); j++) {
                    document.getElementById(to_check[j]).checked = true;
                }
            }
        }*/
    </script>


    <script>
        //keep tracks of subject where they are checked for division,day,time slot.
        var subject_dictionary = [];
        var block_room_list = {};

        var subject_teacher_json ={{ subject_teacher_json|safe }};
        var all_divisions = {{ division|safe }};
        var batches_json ={{ batches_json|safe }};
        var theory_room = {{ theory_room|safe }};
        var practical_room = {{ practical_room|safe }};
        var all_subjects = {{ all_subjects|safe }};


        function create_subject_dictionary() {
            $.each(all_subjects, function (i, element) {
                subject_dictionary[element] = [];
            });
        }

        function create_room_dictionary() {
            {#alert('up');#}
            $.each(theory_room, function (i, element) {
                {#alert('here0');#}
                block_room_list[element] = [];
            });
            $.each(practical_room, function (i, element) {
                {#alert('here0');#}
                block_room_list[element] = [];
            });
        }


        {#Checkbox checked#}

        function add_remove_from_dictionary(checkbox_object) {
            if (document.getElementById("id_subject").value !== "") {


                let id = checkbox_object.id;
                let selected_subject = document.getElementById("id_subject").value;
                let id_splilt_array = id.split('_');
                let division = id_splilt_array[configuration['division_index']];
                let time = id_splilt_array[configuration['time_index']];
                let day = id_splilt_array[configuration['day_index']];
                let year = id_splilt_array[configuration['year_index']];
                let teachers = subject_teacher_json[selected_subject][division];
                if (checkbox_object.checked) {
                    if (is_practical(selected_subject) === false) {
                        checkbox_object.classList.add("checked-cbx");
                        subject_dictionary[selected_subject].push(id);
                        let checkbox_parent_object = checkbox_object.parentElement;

                        //add <span> Subject</span>
                        let subject_object = document.createElement("span");
                        let subject_text = document.createTextNode(selected_subject);
                        subject_object.appendChild(subject_text);
                        subject_object.id = "id_subject_" + time + "_" + division + "_" + day + "_" + year;
                        checkbox_parent_object.appendChild(subject_object);

                        //add <select> Teacher </select>
                        let teacher_object = document.createElement("select");
                        checkbox_parent_object.appendChild(teacher_object);
                        teacher_object.id = "id_teacher_" + time + "_" + division + "_" + day + "_" + year;

                        $.each(teachers, function (i, element) {
                            let option = document.createElement("option");
                            option.value = element;
                            option.text = element;
                            teacher_object.appendChild(option);
                        });
                        checkbox_parent_object.classList.add("checked-cbx-parent");
                        block_checkbox(checkbox_object, teachers, selected_subject, time, year, day, division, false);

                        //add <select> Room </select>
                        let room_object = document.createElement("select");
                        room_object.setAttribute('onfocus', 'set_previous_value(this)');
                        room_object.setAttribute('onchange', 'room_change_block(this)');
                        checkbox_parent_object.appendChild(room_object);
                        room_object.id = "id_room_" + time + "_" + division + "_" + day + "_" + year;

                        $.each(theory_room, function (i, element) {
                            if (block_room_list[element].indexOf(room_object.id) === -1) {
                                let option = document.createElement("option");
                                option.value = element;
                                option.text = element;
                                room_object.appendChild(option);
                            }
                        });
                        let current_room = room_object.value;
                        block_room(room_object.id, current_room, false);
                    }
                    else {
                        {#$('#myModal').modal('show');#}
                        checkbox_object.classList.add("practical-cbx");
                        checkbox_object.parentElement.classList.add("practical-cbx-parent");
                        {#let table_obj = document.getElementById('modalBody');#}
                        {#alert(year);#}
                        {#alert(division);#}

                        {#console.log(batches_json[year][division]);#}
                        {#let index = Object.keys(batches_json[year]).indexOf(division);#}
                        {#alert(index);#}
                        {#for (var batch in batches_json[year][division]) {#}
                        {#    let row_obj = document.createElement('tr');#}
                        {#    let column_obj = document.createElement('td');#}
                        {#    column_obj.innerHTML = batches_json[year][division][batch];#}
                        {#    row_obj.appendChild(column_obj);#}
                        {##}
                        {#    column_obj = document.createElement('td');#}
                        {#    let select_obj = document.createElement('select');#}
                        {#    for(let sub in all_subjects) {#}
                        {#        if(is_practical(all_subjects[sub])) {#}
                        {#            let option = document.createElement("option");#}
                        {#            option.value = all_subjects[sub];#}
                        {#            option.text = all_subjects[sub];#}
                        {#            select_obj.appendChild(option);#}
                        {#        }#}
                        {#    }#}
                        {#    column_obj.appendChild(select_obj);#}
                        {#    row_obj.appendChild(column_obj);#}
                        {##}
                        {#    column_obj = document.createElement('td');#}
                        {#    select_obj = document.createElement('option');#}
                        {#    for(let teacher in subject_teacher_json[selected_subject])#}
                        {#    row_obj.appendChild(column_obj);#}
                        {##}
                        {#    column_obj = document.createElement('td');#}
                        {#    select_obj = document.createElement('select');#}
                        {#    $.each(practical_room, function (i, element) {#}
                        {#        let option = document.createElement("option");#}
                        {#        option.value = element;#}
                        {#        option.text = element;#}
                        {#        select_obj.appendChild(option);#}
                        {#    });#}
                        {#    column_obj.appendChild(select_obj);#}
                        {#    row_obj.appendChild(column_obj);#}
                        {##}
                        {#    table_obj.appendChild(row_obj);#}
                        {#}#}

                    }


                }
                else {
                    console.log('id_subject_' + time + '_' + division + '_' + day);
                    let local_selected_subject = document.getElementById('id_subject_' + time + '_' + division + '_' + day + "_" + year).innerHTML;
                    let local_teachers = [document.getElementById('id_teacher_' + time + '_' + division + '_' + day + "_" + year).value];
                    let index = subject_dictionary[local_selected_subject].indexOf(id);
                    if (index !== -1) {
                        subject_dictionary[local_selected_subject].splice(index, 1);
                        checkbox_object.classList.remove("checked-cbx");
                        checkbox_object.parentElement.classList.remove("checked-cbx-parent");
                        checkbox_object.parentElement.removeChild(document.getElementById("id_teacher_" + time + "_" + division + "_" + day + "_" + year));
                        checkbox_object.parentElement.removeChild(document.getElementById("id_subject_" + time + "_" + division + "_" + day + "_" + year));
                        let room_obj = document.getElementById("id_room_" + time + "_" + division + "_" + day + "_" + year);
                        block_room(checkbox_object.id, room_obj.value, true);
                        checkbox_object.parentElement.removeChild(room_obj);
                        block_checkbox(checkbox_object, local_teachers, local_selected_subject, time, year, day, division, true, selected_subject);
                    }
                    else {
                        alert('Some error occured');
                        alert('Should never go here');
                    }

                }

            }
        }

        function room_change_block(room_obj) {
            block_room(room_obj.id, previous, true);
            block_room(room_obj.id, room_obj.value, false);
        }
    </script>

    {#    Check if subject is practical#}
    <script>
        function is_practical(subject) {
            for (var i = 0; i < all_years.length; i++) {
                if (subjects_json[all_years[i]]['practical'].indexOf(subject) !== -1) {
                    return true;
                }
            }
            return false;
        }

    </script>
    {#    Get previous of combo box room#}
    <script>
        var previous;

        function set_previous_value(obj) {
            previous = obj.value;
            console.log(previous);
            obj.blur();
        }
    </script>

    <script>
        function block_room(cbx_id, current_room, complement) {
            {#alert(current_room);#}
            let cbx = cbx_id.split('_');
            for (let yr in all_years) {
                {#alert(yr);#}
                for (let div in all_divisions) {
                    {#alert(current_room);#}
                    let block_id = cbx[0] + '_' + cbx[1] + '_' + cbx[2] + '_' + all_divisions[div] + '_' + cbx[4] + '_' + all_years[yr];
                    if (!(all_divisions[div] === cbx[configuration['division_index']] && all_years[yr] === cbx[configuration['year_index']])) {
                        if (complement === false) {
                            block_room_list[current_room].push(block_id);
                            if (document.getElementById(block_id)) {
                                let blocked = document.getElementById(block_id);
                                blocked.removeChild(blocked.querySelector('option[value="' + current_room + '"]'));
                            }
                        }
                        else {
                            let index = block_room_list[current_room].indexOf(block_id);
                            block_room_list[current_room].splice(index, 1);
                            if (document.getElementById(block_id)) {
                                let blocked = document.getElementById(block_id);
                                var option_element = document.createElement('option');
                                option_element.text = current_room;
                                option_element.value = current_room;
                                blocked.appendChild(option_element);
                            }
                        }
                    }
                }
            }
        }
    </script>


    {#    Subject combobox onchange function#}
    <script>
        function change_selected_subject(subject_obj) {

            let current_subject = subject_obj.value;
            block_all_current_subject(current_subject, true);

        }
    </script>



    {#    Document on loading function#}
    <script>
        function on_document_loading() {
            create_room_dictionary();
            create_subject_dictionary();
            set_subject();

        }
    </script>


    {#    Bind document on ready to function#}
    <script>
        $(document).ready(on_document_loading());
    </script>


    {#Create blocking list selected subject#}
    <script>
        var block_list = {};
        for (subject in subject_teacher_json) {
            if (subject_teacher_json.hasOwnProperty(subject)) {
                block_list[subject] = []
            }
        }


        function block_checkbox(checkbox_object, teachers, current_subject, time, year, day, current_division, complement, real_selected) {
            {#alert(subject_teacher_json.length);#}
            for (subject in subject_teacher_json) {
                if (subject_teacher_json.hasOwnProperty(subject)) {
                    for (division in subject_teacher_json[subject]) {
                        if (subject_teacher_json[subject].hasOwnProperty(division)) {
                            if (subject_teacher_json[subject][division][0] === teachers[0]) {
                                if (!(subject === current_subject && current_division === division)) {
                                    let subject_year = "";
                                    for (each_year in subjects_json) {
                                        if (subjects_json.hasOwnProperty(each_year)) {
                                            if ((subjects_json[each_year]['practical'].indexOf(subject) !== -1) || (subjects_json[each_year]['theory'].indexOf(subject) !== -1)) {
                                                subject_year = each_year;
                                                break;
                                            }

                                        }
                                    }

                                    if (subject_year !== "") {
                                        let id = 'id_room_' + time + '_' + division + '_' + day + '_' + subject_year + '_cbx';
                                        if (complement === false) {
                                            block_list[subject].push(id);
                                            {#alert(subject + current_subject + current_division + division);#}
                                        }
                                        else {
                                            let index = block_list[subject].indexOf(id);
                                            block_list[subject].splice(index, 1);
                                            document.getElementById(id).disabled = false;
                                        }
                                    }

                                    else {
                                        alert('Subject not found');
                                        alert('Should never go here');
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if (complement == false) {
                block_all_current_subject(current_subject, false);
            }
            else {
                block_all_current_subject(real_selected, false);
            }
        }


        function block_all_current_subject(current_subject, previous_unblock) {

            {#alert(previous_unblock);#}
            let current_block_list = block_list[current_subject];


            for (i = 0; i < current_block_list.length; i++) {
                let checkbox_object = document.getElementById(current_block_list[i]);
                {#alert(checkbox_object.id);#}
                if (checkbox_object.checked === false) {
                    checkbox_object.disabled = true;
                }
            }


            if (previous_unblock === true && global_current_subject !== "") {
                unblock_previous_subject();
            }

            global_current_subject = current_subject;

            console.log(block_list);
        }


        function unblock_previous_subject() {
            let previous_block_list = block_list[global_current_subject];
            for (i = 0; i < previous_block_list.length; i++) {
                document.getElementById(previous_block_list[i]).disabled = false;
            }
        }
    </script>

    {#    Remove ids from block_list#}


{% endblock html %}