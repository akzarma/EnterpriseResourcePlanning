{% extends 'dashboard_faculty.html' %}
{% block title %}
    Exam-Schedule | ERP
{% endblock title %}



{% block content %}
    <table class="table">
        <thead>
        <tr>
            <th></th>
            <th>Sr no.</th>
            <th>Exam</th>
            <th>Schedule</th>
            <th>Subjects</th>
        </tr>
        </thead>
        <tbody>
        {% for each_exam in exams %}
            <tr>
                <td><input type="checkbox" name="exam" value="{{ each_exam.id }}"></td>
                <td>{{ forloop.counter }}</td>
                <td>{{ each_exam.exam.exam_name }}</td>
                <td>{{ each_exam.schedule_start_date }}</td>
                <td>
                    {% for each_subject in each_exam.examsubject_set.all %}
                        {{ each_subject.subject.short_form }}
                    {% endfor %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% for each_room in available_rooms %}
        <input type="checkbox" name="room" value="{{ each_room.room_number }}">
        <label>{{ each_room.room_number }}</label>
    {% endfor %}
    <br><br>
    <input class="btn btn-primary" type="button" value="Check Availability" name="possible"
           onclick="check_availability();">


    <div id="exam_schedule"></div>
    <script>
        function check_availability() {

            let all_rooms = document.getElementsByName('room');

            let all_exams = document.getElementsByName('exam');

            let all_exams_id = [];
            let all_room_number = [];

            for (let i = 0; i < all_exams.length; i++) {
                if (all_exams[i].checked) {
                    all_exams_id.push(all_exams[i].value)
                }
            }
            for (let i = 0; i < all_rooms.length; i++) {
                if (all_rooms[i].checked) {
                    all_room_number.push(all_rooms[i].value)
                }
            }

            $.ajax({
                type: "POST",
                url: '{% url 'exam:check_availability' %}',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'room': all_room_number,
                    'exam': all_exams_id
                },
                success: function (data) {
                    var data = JSON.parse(data);
                    console.log(data);
                    let main_container = document.getElementById('exam_schedule');
                    for (let branch in data) {
                        let branch_div = document.createElement('div');
                        branch_div.style.alignContent = "center";
                        branch_div.setAttribute("class", "row");
                        let heading = document.createElement('h2');
                        heading.innerHTML = branch;
                        branch_div.appendChild(heading);
                        main_container.appendChild(branch_div);

                        for (let exam in data[branch]) {
                            let exam_div = document.createElement('div');
                            exam_div.style.alignContent = "center";
                            exam_div.setAttribute("class", "row");
                            let heading = document.createElement('h3');
                            heading.innerHTML = exam;
                            exam_div.appendChild(heading);
                            main_container.appendChild(exam_div);


                            for (let date in data[branch][exam]) {
                                let row_div = document.createElement('div');
                                row_div.setAttribute("class", "row");
                                let date_div = document.createElement('div');
                                date_div.setAttribute("class", "col-md-2");
                                let time_div = document.createElement('div');
                                time_div.setAttribute("class", "col-md-2");
                                let room_div = document.createElement('div');
                                room_div.setAttribute("class", "col-md-1");
                                let roll_div = document.createElement('div');
                                roll_div.setAttribute("class", "col-md-7");

                                let heading = document.createElement('h3');
                                heading.innerHTML = date;
                                date_div.appendChild(heading);
                                row_div.appendChild(date_div);

                                for (let time in data[branch][exam][date]) {
                                    let row = document.createElement('div');
                                    row.setAttribute("class", "row");
                                    let heading = document.createElement('h3');
                                    heading.innerHTML = time;
                                    row.appendChild(heading);
                                    time_div.appendChild(row);

                                    for (let room in data[branch][exam][date][time]) {
                                        row = document.createElement('div');
                                        row.setAttribute("class", "row");
                                        let heading = document.createElement('h4');
                                        heading.innerHTML = room;
                                        row.appendChild(heading);
                                        room_div.appendChild(row);

                                        row = document.createElement('div');
                                        row.setAttribute("class", "row");
                                        let para = document.createElement('p');
                                        let count = 0;
                                        for (let i in data[branch][exam][date][time]) {
                                            if (count === 7) {
                                                para.innerHTML += data[branch][exam][date][time][i] + "<br/>";
                                                count = 0;
                                            } else {
                                                para.innerHTML += data[branch][exam][date][time][i] + "&nbsp";
                                                count = count + 1;
                                            }
                                        }
                                        row.appendChild(para);
                                        roll_div.appendChild(row);
                                    }


                                }
                                row_div.appendChild(time_div);
                                row_div.appendChild(room_div);
                                row_div.appendChild(roll_div);
                                main_container.appendChild(row_div);

                            }
                        }
                    }
                }
            });
        }
    </script>

{% endblock content %}
